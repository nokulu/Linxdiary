<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tehtäväindeksi — Linxdiary</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <div>
        <h1>Linxdiary</h1>
        <p class="subtitle">Tehtäväindeksi</p>
      </div>
      <nav class="nav">
        <a class="btn secondary" href="./index.html">Etusivu</a>
        <a class="btn" href="https://github.com/nokulu/Linxdiary/blob/main/paivakirja.md" target="_blank" rel="noopener">Näytä GitHubissa</a>
      </nav>
    </header>

    <section class="section card">
      <div class="breadcrumb">
        <a href="./index.html">Etusivu</a>
        <span class="breadcrumb-separator">/</span>
        <span>Tehtäväindeksi</span>
      </div>
      <h2>Kaikki tehtävät päivittäin</h2>
      <div id="task-index">
        <noscript>Ota JavaScript käyttöön nähdäksesi tehtävät.</noscript>
      </div>
    </section>

    <footer>
      <p>© Linxdiary — <a href="https://github.com/nokulu/Linxdiary" target="_blank" rel="noopener">GitHub</a></p>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    (async function() {
      const indexEl = document.getElementById('task-index');
      
      function slugify(text) {
        return text.trim().toLowerCase()
          .replace(/ä/g, 'a').replace(/ö/g, 'o').replace(/å/g, 'a')
          .replace(/\s+/g, '-')
          .replace(/[^a-z0-9\-]/g, '');
      }
      
      try {
        // Fetch from relative path (works in private repos)
        const resp = await fetch('./paivakirja.md', { cache: 'no-cache' });
        if (!resp.ok) throw new Error('Ei voitu ladata paivakirja.md');
        const md = await resp.text();
        
        // Parse the markdown to extract days and tasks
        const lines = md.split('\n');
        let currentDay = null;
        let currentDayTitle = '';
        const days = [];
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // Day header (## Päivä X — ...)
          if (line.match(/^##\s+Päivä\s+\d+/i)) {
            if (currentDay) {
              days.push(currentDay);
            }
            currentDayTitle = line.replace(/^##\s+/, '').trim();
            currentDay = { title: currentDayTitle, tasks: [] };
          }
          // Task header (### Tehtävä: ...)
          else if (line.match(/^###\s+Tehtävä:/i)) {
            const taskTitle = line.replace(/^###\s+Tehtävä:\s*/i, '').trim();
            const slug = slugify(currentDayTitle + ' ' + taskTitle);
            if (currentDay) {
              currentDay.tasks.push({ title: taskTitle, slug: slug });
            }
          }
        }
        
        // Don't forget the last day
        if (currentDay) {
          days.push(currentDay);
        }
        
        // Build the HTML
        let html = '';
        days.forEach(day => {
          html += `<div class="day-group">`;
          html += `<h3 class="day-title">${day.title}</h3>`;
          html += `<ul class="task-list">`;
          day.tasks.forEach(task => {
            html += `<li><a class="task-link" href="./tehtava.html?slug=${encodeURIComponent(task.slug)}">`;
            html += `<strong>Tehtävä:</strong> ${task.title}`;
            html += `</a></li>`;
          });
          html += `</ul></div>`;
        });
        
        indexEl.innerHTML = html;
        
      } catch (e) {
        indexEl.innerHTML = '<p>Virhe sisällön latauksessa. <a href="https://github.com/nokulu/Linxdiary/blob/main/paivakirja.md" target="_blank" rel="noopener">Avaa GitHubissa</a>.</p>';
        console.error(e);
      }
    })();
  </script>
</body>
</html>
