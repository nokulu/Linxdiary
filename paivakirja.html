<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tehtävät — Linxdiary</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .day-section {
      margin-bottom: 28px;
    }
    .day-section h2 {
      margin-bottom: 12px;
      color: #f8fafc;
      font-size: 1.5rem;
    }
    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .task-list li {
      margin: 8px 0;
    }
    .task-link {
      display: block;
      padding: 12px 16px;
      background: rgba(2,6,23,0.4);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 10px;
      color: #93c5fd;
      text-decoration: none;
      transition: all 0.2s;
    }
    .task-link:hover {
      background: rgba(148,163,184,0.1);
      border-color: rgba(148,163,184,0.4);
      text-decoration: none;
      transform: translateX(4px);
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div>
        <h1>Linxdiary</h1>
        <p class="subtitle">Oppimispäiväkirja (Linux-perusteet)</p>
      </div>
      <nav class="nav">
        <a class="btn secondary" href="./index.html">Etusivu</a>
        <a class="btn" href="https://github.com/nokulu/Linxdiary/blob/main/paivakirja.md" target="_blank" rel="noopener">Näytä GitHubissa</a>
      </nav>
    </header>

    <section class="section card">
      <h3>Tehtävät päivittäin</h3>
      <div id="task-index">
        <noscript>Ota JavaScript käyttöön nähdäksesi tehtävälistan.</noscript>
      </div>
    </section>

    <footer>
      <p>© Linxdiary — <a href="https://github.com/nokulu/Linxdiary" target="_blank" rel="noopener">GitHub</a></p>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    (async function() {
      const taskIndexEl = document.getElementById('task-index');
      try {
        // Fetch markdown from relative URL (private-repo friendly)
        const resp = await fetch('./paivakirja.md', { cache: 'no-cache' });
        if (!resp.ok) throw new Error('Ei voitu ladata paivakirja.md');
        const md = await resp.text();
        
        // Parse structure: days and tasks
        const structure = parseMarkdownStructure(md);
        
        // Render task index
        let html = '';
        for (const day of structure) {
          html += `<div class="day-section">`;
          html += `<h2>${escapeHtml(day.title)}</h2>`;
          html += `<ul class="task-list">`;
          for (const task of day.tasks) {
            html += `<li><a class="task-link" href="./tehtava.html?slug=${task.slug}">${escapeHtml(task.title)}</a></li>`;
          }
          html += `</ul></div>`;
        }
        taskIndexEl.innerHTML = html;
        
      } catch (e) {
        taskIndexEl.innerHTML = '<p>Virhe sisällön latauksessa. <a href="https://github.com/nokulu/Linxdiary/blob/main/paivakirja.md" target="_blank" rel="noopener">Avaa GitHubissa</a>.</p>';
        console.error(e);
      }
    })();

    function parseMarkdownStructure(md) {
      const lines = md.split('\n');
      const structure = [];
      let currentDay = null;
      let currentTask = null;
      let contentLines = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Day header (## Päivä X)
        if (line.startsWith('## Päivä ')) {
          // Save previous task if exists
          if (currentTask) {
            currentTask.content = contentLines.join('\n').trim();
            currentDay.tasks.push(currentTask);
          }
          
          // Start new day
          const dayTitle = line.replace(/^##\s+/, '').trim();
          currentDay = {
            title: dayTitle,
            slug: slugify(dayTitle),
            tasks: []
          };
          structure.push(currentDay);
          currentTask = null;
          contentLines = [];
        }
        // Task header (### Tehtävä:)
        else if (line.startsWith('### Tehtävä:')) {
          // Save previous task if exists
          if (currentTask) {
            currentTask.content = contentLines.join('\n').trim();
            currentDay.tasks.push(currentTask);
          }
          
          // Start new task
          const taskTitle = line.replace(/^###\s+Tehtävä:\s*/, '').trim();
          currentTask = {
            title: taskTitle,
            slug: slugify(taskTitle),
            daySlug: currentDay.slug
          };
          contentLines = [line]; // Include the task header
        }
        // Other section headers or regular content
        else if (currentTask) {
          contentLines.push(line);
        }
      }

      // Save last task
      if (currentTask && currentDay) {
        currentTask.content = contentLines.join('\n').trim();
        currentDay.tasks.push(currentTask);
      }

      return structure;
    }

    function slugify(text) {
      return text.toLowerCase()
        .replace(/[äå]/g, 'a')
        .replace(/ö/g, 'o')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
